<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student Scanner</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#0b57d0" />
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }
  </script>

  <style>
    :root { --fg:#0b1320; --muted:#5e6b7a; --brand:#0b57d0; --bg:#f6f8fb; }
    html,body { height:100%; }
    body {
      margin:0; font:16px system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:var(--fg); background:var(--bg);
      display:flex; align-items:center; justify-content:center; min-height:100dvh;
    }
    .card {
      width:min(920px, 96vw); background:#fff; border-radius:18px; padding:20px 20px 16px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
    }
    h1 { margin:0 0 4px 0; font-size:22px; }
    .muted { color:var(--muted); font-size:13px; }
    .row { display:flex; gap:18px; align-items:flex-start; flex-wrap:wrap; }
    .col { flex:1 1 320px; }
    .panel {
      background:#fafbff; border:1px solid #eef1f7; border-radius:14px; padding:14px;
    }
    #status { font-weight:600; }
    #result { font-size:17px; margin-top:6px; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th,td { padding:8px 6px; border-bottom:1px solid #edf1f6; text-align:left; }
    th { font-weight:600; color:#667; background:#f8f9fc; }
    .ok { color:#0a7c2f; font-weight:600; }
    .err { color:#b00020; font-weight:600; }
    .name { font-weight:700; }
    .code { color:#556; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .input-wrap { display:flex; gap:8px; align-items:center; }
    input[type=text] {
      flex:1; padding:10px 12px; font-size:18px; border-radius:12px; border:1px solid #cfd7e3; outline:none;
    }
    .swatch{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle;margin-right:6px;border:1px solid #ccd3de}
    button {
      cursor:pointer; border:none; border-radius:12px; padding:10px 14px; font-weight:600; background:var(--brand); color:#fff;
    }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eaf7ea; color:#0a7c2f; font-size:12px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Student Scanner <span class="pill" id="onlinePill">Online</span></h1>
    <div class="muted">RFID keyboard-wedge or keypad: enter OSIS/RFID + Enter. Shows Name, Locker #/Color, and scan time.</div>

    <div class="row" style="margin-top:14px">
      <!-- Left: Live status + last result + manual entry -->
      <div class="col">
        <div class="panel">
          <div id="status">Ready. Scan a card…</div>
          <div id="result"></div>

          <hr style="border:none;border-top:1px solid #edf1f6; margin:12px -14px" />

          <div class="muted" style="margin-bottom:6px">Manual entry (keypad or typing):</div>
          <form id="manualForm" class="input-wrap" autocomplete="off">
            <input id="manualInput" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Type OSIS or RFID and press Enter" />
            <button type="submit">Enter</button>
          </form>
          <div class="muted" style="margin-top:6px">Tip: The field keeps focus—good for external keypads.</div>
        </div>
      </div>

      <!-- Right: Recent scans -->
      <div class="col">
        <div class="panel">
          <div class="muted" style="margin-bottom:8px">Recent scans (local)</div>
          <table id="historyTbl" aria-label="Scan history">
            <thead>
              <tr>
                <th style="width:30%">Name</th>
                <th style="width:20%">Code</th>
                <th style="width:22%">Locker</th>
                <th style="width:28%">Time</th>
                </tr>
              </thead>
            <tbody id="historyBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="muted" style="margin-top:10px">
      Configure <span class="code">API_BASE</span> + <span class="code">SHARED_SECRET</span> in the script below.
    </div>
  </div>

  <script>
  /**************** CONFIG — EDIT ME ****************/
  // Apps Script Web App /exec URL
  const API_BASE = 'https://red-cake-77d5.evazquez-3e0.workers.dev/';
  (async () => {
    try {
      await fetch(API_BASE, {
        method: 'POST',
        body: new URLSearchParams({ action: 'ping' })
      });
    } catch (_) {}
  })();
    
  // Keyboard-wedge behavior
  const REQUIRED_PREFIX = '';     // set if your scanners add a prefix; else leave ''
  const STRIP_PREFIX = true;
  const UPPERCASE = true;
  const SCAN_CHAR_MS = 30;        // max ms between chars to treat input as "scanner"
  const MIN_LEN = 4;
  const DEDUPE_MS = 1000;
  const HISTORY_SIZE = 25;

  /**************** STATE ****************/
  let buffer = "", lastTs = 0, resetTimer = null;
  let lastScanValue = "", lastScanAt = 0;

  const statusEl = document.getElementById('status');
  const resultEl = document.getElementById('result');
  const historyBody = document.getElementById('historyBody');
  const manualInput = document.getElementById('manualInput');
  const onlinePill = document.getElementById('onlinePill');

  function setStatus(t){ statusEl.textContent = t; }
  function vibrate(){ try{ navigator.vibrate?.(30); }catch{} }
  function esc(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function fmtTime(d){ try{ return new Intl.DateTimeFormat(undefined,{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}).format(d);}catch{return d.toLocaleString();} }

  /**************** API ****************/
  async function apiLookup(code){
    const body = new URLSearchParams({ action:'lookup', code });
    const t0 = performance.now();
    const wakeTimer = setTimeout(() => setStatus('Waking server…'), 700);
    try {
      const r = await fetch(API_BASE, { method:'POST', body });
      clearTimeout(wakeTimer);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    } catch (e) {
      clearTimeout(wakeTimer);
      throw e;
    }
  }

  // (optional) logging
  async function apiLog(entry){
    const body = new URLSearchParams({
      action:'log',
      whenISO: entry.whenISO || new Date().toISOString(),
      code: entry.code || '',
      source: entry.source || 'pwa',
      resolved_name:  entry.resolved?.name  || '',
      resolved_osis:  entry.resolved?.osis  || '',
      resolved_lnum:  entry.resolved?.locker_number || '',
      resolved_lcol:  entry.resolved?.locker_color  || ''
    });
    try { await fetch(API_BASE, { method:'POST', body }); } catch {}
  }

  /**************** SCAN FLOW ****************/
  function normalize(raw){
    let v = String(raw).trim();
    if (UPPERCASE) v = v.toUpperCase();
    if (REQUIRED_PREFIX){
      if (!v.startsWith(REQUIRED_PREFIX)) return '';
      if (STRIP_PREFIX) v = v.slice(REQUIRED_PREFIX.length);
    }
    return v;
  }

  let scanSeq = 0;
  
  function onScan(code){
    const when = new Date();
    const seq = ++scanSeq;
  
    // 1) create a placeholder row in order
    const row = pushPendingRow(seq, code, when);
  
    // 2) kick off lookup (async)
    void (async () => {
      try {
        const res = await apiLookup(code);           // calls Worker -> GAS
        if (res.found) {
          updateRowToSuccess(row, {
            name: res.name, code,
            lockerNum: res.locker_number,
            lockerColor: res.locker_color,
            when
          });
          // fire-and-forget log
          apiLog({ whenISO: when.toISOString(), code, source: 'pwa', resolved: res });
        } else {
          updateRowToNotFound(row, code, when, res.error, res.reason);
        }
      } catch (err) {
        updateRowToError(row, code, when, err);
      }
    })();
  }

  function showSuccess(name, code, lockerNum, lockerColor, when){
    resultEl.innerHTML =
      `<div class="ok">OK</div>
       <div class="name">${esc(name || 'Unknown')}</div>
       <div class="code">${esc(code)} — Locker ${esc(lockerNum || '—')} (${esc(lockerColor || '—')})</div>
       <div class="muted">${fmtTime(when)}</div>`;
    pushHistoryRow(name || 'Unknown', code, lockerNum, lockerColor, when);
    setStatus('Ready. Scan next card…');
  }

  function showNotFound(code, when){
    resultEl.innerHTML =
      `<div class="ok">OK</div>
       <div class="name">${esc(name || 'Unknown')}</div>
       <div class="code">${esc(code)} — Locker ${esc(lockerNum || '—')} (${esc(lockerColor || '—')})</div>
       <div class="muted">${fmtTime(when)}</div>`;
    pushHistoryRow('— Not found —', code, when);
    setStatus('Ready.');
  }

  function showError(err, code, when){
    resultEl.innerHTML =
      `<div class="err">Lookup error</div>
       <div class="code">${esc(code||'')}</div>
       <div class="muted">${fmtTime(when)} — ${esc(err.message||String(err))}</div>`;
    setStatus('Ready.');
  }

  function pushHistoryRow(name, code, lockerNum, lockerColor, when){
    const tr = document.createElement('tr');
    const color = String(lockerColor||'').trim();
    const num   = String(lockerNum||'').trim();
  
    // try to map common color names to CSS colors; fallback to text
    const cssColor = ({
      red:'#e53935', blue:'#1e88e5', green:'#43a047', yellow:'#fdd835',
      purple:'#8e24aa', orange:'#fb8c00', pink:'#d81b60', gray:'#78909c',
      grey:'#78909c', black:'#263238', white:'#fafafa', teal:'#009688'
    })[color.toLowerCase()] || null;
  
    const lockerHtml = (num || color)
      ? (cssColor
          ? `<span class="swatch" style="background:${cssColor}"></span>${esc(num)} <span class="muted">(${esc(color)})</span>`
          : `${esc(num)} <span class="muted">(${esc(color)})</span>`)
      : '—';
  
    tr.innerHTML =
      `<td class="name">${esc(name)}</td>
       <td class="code">${esc(code)}</td>
       <td>${lockerHtml}</td>
       <td>${fmtTime(when)}</td>`;
    historyBody.prepend(tr);
    while (historyBody.children.length > HISTORY_SIZE) historyBody.lastChild.remove();
  }

  function pushPendingRow(seq, code, when){
    const tr = document.createElement('tr');
    tr.dataset.seq = String(seq);
    tr.innerHTML =
      `<td class="name"><em>…looking up…</em></td>
       <td class="code">${esc(code)}</td>
       <td>—</td>
       <td>${fmtTime(when)}</td>`;
    historyBody.prepend(tr); // newest at top, still preserves input order because we insert on scan
    trimHistory();
    return tr;
  }
  
  function updateRowToSuccess(tr, {name, code, lockerNum, lockerColor, when}){
    const color = (lockerColor||'').trim();
    const cssColor = ({
      red:'#e53935', blue:'#1e88e5', green:'#43a047', yellow:'#fdd835',
      purple:'#8e24aa', orange:'#fb8c00', pink:'#d81b60', gray:'#78909c',
      grey:'#78909c', black:'#263238', white:'#fafafa', teal:'#009688'
    })[color.toLowerCase()] || null;
  
    const lockerHtml = (lockerNum || color)
      ? (cssColor
          ? `<span class="swatch" style="background:${cssColor}"></span>${esc(lockerNum||'')} <span class="muted">(${esc(color)})</span>`
          : `${esc(lockerNum||'')} <span class="muted">(${esc(color)})</span>`)
      : '—';
  
    tr.innerHTML =
      `<td class="name">${esc(name||'Unknown')}</td>
       <td class="code">${esc(code)}</td>
       <td>${lockerHtml}</td>
       <td>${fmtTime(when)}</td>`;
  }
  
  function updateRowToNotFound(tr, code, when, error, reason){
    const msg = error === 'invalid_input'
      ? (reason === 'leading_zero_osis'
          ? 'Leading-zero OSIS — scan card.'
          : 'Digits only.')
      : 'Not found';
    tr.innerHTML =
      `<td class="name"><span class="bad">${esc(msg)}</span></td>
       <td class="code">${esc(code)}</td>
       <td>—</td>
       <td>${fmtTime(when)}</td>`;
  }
  
  function updateRowToError(tr, code, when, err){
    tr.innerHTML =
      `<td class="name"><span class="bad">Lookup error</span></td>
       <td class="code">${esc(code)}</td>
       <td>—</td>
       <td>${fmtTime(when)}</td>`;
  }
  
  function trimHistory(){
    while (historyBody.children.length > HISTORY_SIZE) historyBody.lastChild.remove();
  }



  /**************** KEYBOARD-WEDGE LISTENER ****************/
window.addEventListener('keydown', (e)=>{
  keepFocus();

  const now = performance.now();
  // if gap is big, this is a new sequence
  const isNewSeq = !lastTs || (now - lastTs) > SCAN_CHAR_MS;
  lastTs = now;

  if (e.key === 'Enter'){
    const finished = buffer; buffer = "";
    if (finished){
      onScan(finished);
      manualInput.value = '';                      // clear after scan
      e.preventDefault();
    }
    return;
  }

  if (e.key.length === 1){
    const likelyScanner = !isNewSeq || buffer.length > 0;  // chars arriving quickly
    if (likelyScanner){
      e.preventDefault();                      // don't let wedge print into the input
      buffer += e.key;
    } else {
      // human typing: let it appear and also keep our buffer in sync
      buffer += e.key;
    }
  }

  clearTimeout(resetTimer);
  resetTimer = setTimeout(()=> buffer="", 200);
}, true);

  /**************** MANUAL ENTRY FORM ****************/
  document.getElementById('manualForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const v = manualInput.value.trim();
    if (v) onScan(v);
    manualInput.value = '';
    keepFocus();
  });

  function keepFocus(){
    if (document.activeElement !== manualInput) manualInput.focus({preventScroll:true});
    manualInput.setSelectionRange(manualInput.value.length, manualInput.value.length);
  }
  keepFocus(); setInterval(keepFocus, 1000);

  /**************** ONLINE/OFFLINE INDICATOR ****************/
  function updateOnlinePill(){
    const on = navigator.onLine;
    onlinePill.textContent = on ? 'Online' : 'Offline';
    onlinePill.style.background = on ? '#eaf7ea' : '#fff3e0';
    onlinePill.style.color = on ? '#0a7c2f' : '#8a5a00';
  }
  window.addEventListener('online', updateOnlinePill);
  window.addEventListener('offline', updateOnlinePill);
  updateOnlinePill();
  </script>
</body>
</html>
