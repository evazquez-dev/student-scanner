<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Student Scanner</title>
<style>
  :root { --bg:#0b0f1a; --card:#121826; --ink:#e6eefc; --muted:#8fa1c1; --ok:#0aa84f; --bad:#d7263d; --accent:#4c83ff; }
  * { box-sizing: border-box; }
  html, body { height: 100%; background: var(--bg); color: var(--ink); font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .wrap { max-width: 900px; margin: 0 auto; padding: 16px; }
  header { display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom: 10px; }
  header .left { display:flex; gap:12px; align-items:center; }
  .pill { padding: 6px 10px; border-radius: 20px; font-weight: 600; background: #17223a; color: var(--muted); }
  .pill.good { color:#aef2c7; background:#0d2a1b; border:1px solid #156b3c;}
  .pill.bad  { color:#ffd1d9; background:#3a151b; border:1px solid #8b2230;}
  .pill.accent { color:#e7ecff; background:#1a2b5c; border:1px solid #4c83ff; }
  .title { font-size: 18px; font-weight: 700; color:#dbe5ff; }
  .card { background: var(--card); border:1px solid #202b40; border-radius: 14px; padding: 14px; margin: 12px 0; }
  .row { display:flex; gap:10px; align-items:center; }
  .grow { flex:1; }
  input[type="text"] { width: 100%; padding: 12px 14px; background:#0d1424; color:var(--ink); border:1px solid #203050; border-radius: 12px; font-size: 18px; }
  input[type="text"]::placeholder { color:#6f86b3; }
  button { border:0; background:#213255; color:#eaf0ff; padding: 10px 14px; border-radius: 12px; font-weight: 700; cursor: pointer; }
  button:hover { filter: brightness(1.1); }
  .btn-ok { background:#0b57d0; }
  .btn-danger { background:#7a1220; }
  .btn-ghost { background:#17223a; color:#bcd0ff; border:1px solid #263760; }
  .stack { display:flex; flex-direction: column; gap:12px; }
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }
  .student { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border:1px dashed #2a3a62; border-radius:10px; }
  .student b { font-size: 16px; }
  .muted { color: var(--muted); }
  .status { font-size: 14px; color: var(--muted); min-height: 1.2em; }
  footer { margin-top: 18px; display:flex; gap:10px; align-items:center; justify-content:space-between; color:#9fb4dd; }
  code { background:#0c1324; border:1px solid #1f2b4a; padding:2px 6px; border-radius:8px; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="left">
      <div class="title">Student Scanner</div>
      <div id="locPill" class="pill accent">Location: <span id="locName">—</span></div>
      <div id="bindPill" class="pill">Device: <span id="devIdShort">—</span></div>
    </div>
    <div>
      <button id="btnSetDevice" class="btn-ghost">Set Device</button>
    </div>
  </header>

  <div class="card stack" id="scanCard">
    <div class="row">
      <div class="grow">
        <input id="scanInput" type="text" inputmode="numeric" autocomplete="one-time-code"
               placeholder="Scan card or type OSIS / RFID and press Enter…" />
      </div>
      <div>
        <button id="btnFocus" class="btn-ghost">Focus</button>
      </div>
    </div>
    <div class="status" id="scanStatus"></div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b>Latest Result</b>
        <div id="resultPill" class="pill">—</div>
      </div>
      <div id="latest" class="stack">
        <div class="muted">Waiting for a scan…</div>
      </div>
    </div>

    <div class="card stack">
      <div class="row" style="justify-content:space-between">
        <b id="listTitle">Present List</b>
        <div class="row" style="gap:8px">
          <button id="btnClearList" class="btn-danger" style="display:none">Clear</button>
          <button id="btnReset" class="btn-ghost">Reset View</button>
        </div>
      </div>
      <div id="presentList" class="stack"></div>
      <div class="status" id="clearStatus"></div>
    </div>
  </div>

  <footer>
    <div>Bound: <code id="boundInfo">—</code></div>
    <div>Device ID: <code id="deviceIdFooter">—</code></div>
  </footer>
</div>

<script>
/** =========================
 *  LIGHT CONFIG (edit me)
 *  ========================= */
const WORKER_URL = 'https://red-cake-77d5.evazquez-3e0.workers.dev/'; // trailing slash OK
const ORIGIN_OK  = window.location.origin;
const DEFAULT_DEVICE_ID = ''; // optional fallback

/** =========================
 *  STATE
 *  ========================= */
let DEVICE_ID = localStorage.getItem('SCN_DEVICE_ID') || DEFAULT_DEVICE_ID || '';
let LOCKED_LOCATION = ''; // set by /device_location
let MODE = 'generic';     // 'bathroom' | 'senior_outin' | 'generic'
let PRESENT = [];         // array of { osis, name, sex? }

/** =========================
 *  UTIL
 *  ========================= */
function $(id){ return document.getElementById(id); }
function shortId(id){ return id ? id.slice(0,8)+'…' : '—'; }
function setStatus(el,msg,kind){
  el.textContent = msg || '';
  const pill = $('resultPill');
  if (kind === 'ok') { pill.textContent='OK'; pill.className='pill good'; }
  else if (kind === 'bad') { pill.textContent='Error'; pill.className='pill bad'; }
  else { pill.textContent='—'; pill.className='pill'; }
}
async function postForm(params){
  const body = new URLSearchParams(params);
  const r = await fetch(WORKER_URL, {
    method: 'POST',
    headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8', 'Accept':'application/json' },
    body: body.toString(),
    credentials: 'include'
  });
  const ct = r.headers.get('content-type') || '';
  const text = await r.text();
  if (!ct.includes('application/json')) throw new Error('Non-JSON from worker');
  const json = JSON.parse(text);
  if (!r.ok) throw new Error(json?.error || ('HTTP '+r.status));
  return json;
}
function renderPresent(){
  const box = $('presentList');
  box.innerHTML = '';
  if (!PRESENT.length){
    box.innerHTML = '<div class="muted">No students in list.</div>';
    return;
  }
  for (const s of PRESENT){
    const div = document.createElement('div');
    div.className = 'student';
    div.innerHTML = `
      <div>
        <b>${escapeHtml(s.name||'')}</b>
        <div class="muted">OSIS: ${escapeHtml(s.osis||'')}</div>
      </div>
      <button class="btn-ghost" data-osis="${s.osis}">Remove</button>
    `;
    box.appendChild(div);
  }
  // per-row remove
  box.querySelectorAll('button[data-osis]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const os = String(btn.getAttribute('data-osis')||'');
      PRESENT = PRESENT.filter(x => x.osis !== os);
      renderPresent();
    });
  });
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function classifyModeByLocation(loc){
  if (!loc) return 'generic';
  if (loc.toLowerCase() === 'senior lunch (out-in)') return 'senior_outin';
  if (loc.toLowerCase().startsWith('bathroom (')) return 'bathroom';
  return 'generic';
}
function updateButtonsByMode(){
  const btn = $('btnClearList');
  const title = $('listTitle');
  if (MODE === 'bathroom'){
    btn.style.display = '';
    btn.textContent = 'Clear Bathroom';
    title.textContent = 'Currently In Bathroom';
  } else if (MODE === 'senior_outin'){
    btn.style.display = '';
    btn.textContent = 'Clear List';
    title.textContent = 'Currently OUT';
  } else {
    btn.style.display = 'none';
    title.textContent = 'Present List';
  }
}

/** =========================
 *  DEVICE BIND / LOCATION
 *  ========================= */
async function resolveDeviceLocation(){
  if (!DEVICE_ID) {
    $('boundInfo').textContent = 'not set';
    $('devIdShort').textContent = '—';
    $('deviceIdFooter').textContent = '—';
    $('locName').textContent = '—';
    $('bindPill').className = 'pill bad';
    return;
  }
  $('devIdShort').textContent = shortId(DEVICE_ID);
  $('deviceIdFooter').textContent = DEVICE_ID;

  try {
    const j = await postForm({ action:'device_location', device_id: DEVICE_ID });
    LOCKED_LOCATION = j?.location || '';
    $('locName').textContent = LOCKED_LOCATION || '—';
    $('boundInfo').textContent = j?.locked ? `locked to "${LOCKED_LOCATION}"` : 'unbound';
    $('bindPill').className = j?.locked ? 'pill good' : 'pill';
    MODE = classifyModeByLocation(LOCKED_LOCATION);
    updateButtonsByMode();
  } catch (e) {
    $('boundInfo').textContent = 'error';
    $('bindPill').className = 'pill bad';
  }
}

/** =========================
 *  SCANNING + LOOKUP + LOG
 *  ========================= */
async function handleScan(codeRaw){
  const stat = $('scanStatus');
  codeRaw = String(codeRaw||'').trim();
  if (!codeRaw) return;
  $('scanInput').value = '';
  setStatus(stat, 'Scanning…');

  try {
    // 1) Lookup (Worker memory/KV)
    const look = await postForm({ action:'lookup', code: codeRaw });
    if (!look || look.found === false) {
      setStatus(stat, 'Not found', 'bad');
      $('latest').innerHTML = `<div class="muted">No match for <code>${escapeHtml(codeRaw)}</code></div>`;
      return;
    }

    // Show result
    $('latest').innerHTML = `
      <div class="student">
        <div>
          <b>${escapeHtml(look.name)}</b>
          <div class="muted">OSIS: ${escapeHtml(look.osis)} · Lunch: ${escapeHtml(look.lunch||'')}</div>
          <div class="muted">Locker: ${escapeHtml(look.locker_color_effective||'')} ${escapeHtml(look.locker_number_effective||'')}</div>
        </div>
        <div class="pill ${look.allowed_senior ? 'good' : ''}">${look.allowed_senior ? 'Senior ✓' : 'Student'}</div>
      </div>
    `;
    setStatus(stat, 'OK', 'ok');

    // 2) Log to GAS via Worker (standard log path)
    const log_id = `scan:${Date.now()}:${look.osis}`;
    await postForm({
      action: 'log',
      code: look.osis,                 // keep it OSIS-based in logs
      source: 'pwa',
      location: LOCKED_LOCATION || '',
      device_id: DEVICE_ID || '',
      resolved_name: look.name || '',
      resolved_osis: look.osis || '',
      resolved_lnum: look.locker_number || '',
      resolved_lcol: look.locker_color || '',
      allowed: '',                     // normal scan; leave blank (sheet logic can infer)
      log_id
    });

    // 3) Maintain PRESENT list for “Clear” features
    const entry = { osis: String(look.osis||''), name: String(look.name||''), sex: String(look.sex||'') };
    // Bathroom: treat any scan as "IN" list
    // Senior Lunch (out-in): treat scan as "OUT" list entry
    if (MODE === 'bathroom' || MODE === 'senior_outin') {
      // dedup by OSIS
      if (!PRESENT.find(s => s.osis === entry.osis)) {
        PRESENT.push(entry);
        renderPresent();
      }
    }
  } catch (e) {
    setStatus(stat, 'Error: ' + (e?.message || e), 'bad');
  }
}

/** =========================
 *  MANUAL CLEAR (BATHROOM / OUT-IN)
 *  ========================= */
async function manualClear(){
  const clearStat = $('clearStatus');
  if (!PRESENT.length){
    clearStat.textContent = 'Nothing to clear.';
    return;
  }
  clearStat.textContent = 'Clearing…';

  try {
    const out = await postForm({
      action: 'manual_clear',
      device_id: DEVICE_ID || '',
      location: LOCKED_LOCATION || '',
      items_json: JSON.stringify(PRESENT) // [{osis,name,sex?}, ...]
    });
    if (out?.ok === false) throw new Error(out?.error || 'failed');
    const n = Number(out?.cleared || 0);
    PRESENT = [];
    renderPresent();
    clearStat.textContent = `Cleared ${n} entr${n===1?'y':'ies'}.`;
  } catch (e) {
    clearStat.textContent = 'Clear failed: ' + (e?.message || e);
  }
}

/** =========================
 *  WIRING
 *  ========================= */
window.addEventListener('DOMContentLoaded', ()=>{
  // Inputs & buttons
  $('btnFocus').addEventListener('click', ()=> $('scanInput').focus());
  $('btnReset').addEventListener('click', ()=>{
    PRESENT = [];
    renderPresent();
    $('latest').innerHTML = '<div class="muted">Waiting for a scan…</div>';
    $('scanStatus').textContent = '';
    $('resultPill').textContent = '—';
    $('resultPill').className = 'pill';
  });
  $('btnClearList').addEventListener('click', manualClear);

  $('btnSetDevice').addEventListener('click', async ()=>{
    const id = prompt('Enter DEVICE_ID (found on the scanner footer):', DEVICE_ID || '');
    if (id && id.trim()){
      DEVICE_ID = id.trim();
      localStorage.setItem('SCN_DEVICE_ID', DEVICE_ID);
      await resolveDeviceLocation();
    }
  });

  // Scan field handlers
  const input = $('scanInput');
  input.addEventListener('keydown', (ev)=>{
    if (ev.key === 'Enter') {
      ev.preventDefault();
      handleScan(input.value);
    }
  });
  // Autofocus for USB scanners
  setTimeout(()=> input.focus(), 50);

  // Init bind/location
  resolveDeviceLocation();
  renderPresent();
});
</script>
</body>
</html>
